<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Guild Ionia - System (UMD Version)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'xmas-gold': '#fbbf24',
              'xmas-red': '#ef4444',
            },
            animation: {
              'spin-slow': 'spin 3s linear infinite',
            },
          },
        },
      };
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body { background-color: #020617; color: #e2e8f0; overflow: hidden; margin: 0; }
      .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
      .snowflake { position: fixed; top: -10px; color: white; animation: snow 10s linear infinite; pointer-events: none; z-index: 0; }
      @keyframes snow { to { transform: translateY(100vh); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. РАСПАКОВКА БИБЛИОТЕК ---
        const { useState, useEffect, useRef, useMemo } = React;
        const { createRoot } = ReactDOM;
        
        // --- 2. НАСТРОЙКА FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCIFKGZioiflKAAA1tHkIZV0u1sMiPzUjo",
            authDomain: "random-3fbaa.firebaseapp.com",
            projectId: "random-3fbaa",
            storageBucket: "random-3fbaa.firebasestorage.app",
            messagingSenderId: "891768940412",
            appId: "1:891768940412:web:312585e31aade1d7df66f9"
        };

        // Инициализация (безопасная проверка)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore(); // Используем compat версию

        // --- 3. КОМПОНЕНТ ИКОНКИ (Обертка для Lucide) ---
        const Icon = ({ name, size = 16, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    const { icons } = window.lucide;
                    const iconNode = icons[name];
                    if (iconNode) {
                        // Очистка и создание SVG
                        iconRef.current.innerHTML = '';
                        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                        
                        // Атрибуты по умолчанию для Lucide
                        svg.setAttribute('width', size);
                        svg.setAttribute('height', size);
                        svg.setAttribute('viewBox', '0 0 24 24');
                        svg.setAttribute('fill', 'none');
                        svg.setAttribute('stroke', 'currentColor');
                        svg.setAttribute('stroke-width', '2');
                        svg.setAttribute('stroke-linecap', 'round');
                        svg.setAttribute('stroke-linejoin', 'round');
                        svg.classList.add(...(className.split(' ')));

                        // Добавляем содержимое (path, etc)
                        if(iconNode) {
                            // Lucide v0.263+ structure conversion simpler:
                            // Просто используем createIcons API на лету или рисуем примитивно
                            // Для надежности в React без сборки:
                            iconRef.current.innerHTML = `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">${window.lucide.icons[name]?.toSvg ? window.lucide.icons[name].toSvg() : ''}</svg>`;
                        }
                    }
                }
            }, [name, size, className]);
            
            // Fallback render (пока грузится скрипт)
            return <span ref={iconRef} className={className} dangerouslySetInnerHTML={{__html: window.lucide && window.lucide.icons[name] ? window.lucide.icons[name].toSvg({width: size, height: size, class: className}) : ''}} />;
        };

        // --- 4. ОСНОВНАЯ ЛОГИКА ---
        const ACCESS_CODE = "7777";
        const SESSION_DOC_ID = "ACTIVE";

        const GuildManager = ({ isAdmin }) => {
            const [users, setUsers] = useState([]);
            const [q, setQ] = useState("");
            const [newU, setNewU] = useState({ name: "", base: 0 });

            useEffect(() => {
                // Синтаксис compat: db.collection(...)
                return db.collection("users").onSnapshot(snap => {
                    const data = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    setUsers(data);
                });
            }, []);

            const calcDiff = (u) => {
                const cur = u.final > 0 ? Number(u.final) : (u.intermediate > 0 ? Number(u.intermediate) : Number(u.base));
                return Math.max(0, cur - (Number(u.base) || 0));
            };
            
            const filtered = users.filter(u => u.name.toLowerCase().includes(q.toLowerCase()))
                                  .sort((a,b) => calcDiff(b) - calcDiff(a));

            const saveUser = async () => {
                if(!newU.name) return;
                await db.collection("users").add({ ...newU, intermediate: 0, final: 0 });
                setNewU({ name: "", base: 0 });
            };

            const delUser = async (id) => {
                if(confirm("Удалить?")) await db.collection("users").doc(id).delete();
            };

            return (
                <div className="h-full flex flex-col gap-4 p-4">
                     <div className="flex gap-2">
                        <input value={q} onChange={e => setQ(e.target.value)} placeholder="Поиск..." className="bg-slate-800 border border-slate-700 rounded px-3 py-1 text-white w-full" />
                        {isAdmin && <button onClick={saveUser} className="bg-green-600 px-4 rounded text-white font-bold">+</button>}
                     </div>
                     
                     {isAdmin && (
                         <div className="flex gap-2 bg-slate-900 p-2 rounded">
                             <input value={newU.name} onChange={e => setNewU({...newU, name: e.target.value})} placeholder="Ник" className="bg-transparent border-b border-slate-700 text-white w-full" />
                             <input type="number" value={newU.base} onChange={e => setNewU({...newU, base: Number(e.target.value)})} placeholder="База" className="bg-transparent border-b border-slate-700 text-white w-24" />
                         </div>
                     )}

                     <div className="flex-1 overflow-auto custom-scrollbar bg-slate-900/50 rounded border border-white/5">
                        <table className="w-full text-sm text-left">
                            <thead className="text-slate-500 font-bold uppercase bg-slate-900 sticky top-0">
                                <tr>
                                    <th className="p-2">Name</th>
                                    <th className="p-2 text-right">Base</th>
                                    <th className="p-2 text-right text-emerald-400">Diff</th>
                                    {isAdmin && <th className="p-2">Act</th>}
                                </tr>
                            </thead>
                            <tbody>
                                {filtered.map(u => (
                                    <tr key={u.id} className="border-b border-white/5 hover:bg-white/5">
                                        <td className="p-2 font-bold">{u.name}</td>
                                        <td className="p-2 text-right text-slate-500">{u.base}</td>
                                        <td className="p-2 text-right text-emerald-400 font-mono">{calcDiff(u)}</td>
                                        {isAdmin && (
                                            <td className="p-2 text-center text-red-500 cursor-pointer" onClick={() => delUser(u.id)}>X</td>
                                        )}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                     </div>
                </div>
            );
        };

        const LotterySystem = ({ isAdmin }) => {
            const [session, setSession] = useState(null);
            const [spin, setSpin] = useState(false);

            useEffect(() => {
                return db.collection("lotterySessions").doc(SESSION_DOC_ID).onSnapshot(snap => {
                    if(snap.exists) setSession(snap.data());
                });
            }, []);

            // Простая реализация вращения
            const startRoll = async () => {
                if(!isAdmin) return;
                await db.collection("lotterySessions").doc(SESSION_DOC_ID).update({ status: 'rolling' });
                // Через 3 секунды выбираем победителя (симуляция логики)
                setTimeout(async () => {
                    if(session && session.allowed && session.allowed.length > 0) {
                        const winner = session.allowed[Math.floor(Math.random() * session.allowed.length)];
                        await db.collection("lotterySessions").doc(SESSION_DOC_ID).update({ 
                            status: 'revealed',
                            lastWinner: winner
                        });
                    }
                }, 3000);
            };

            const reset = async () => {
                await db.collection("lotterySessions").doc(SESSION_DOC_ID).set({
                    status: 'idle',
                    allowed: [], 
                    currentTier: 15,
                    lastWinner: null
                });
            };
            
            // Функция проверки участников (Load from Users)
            const loadUsers = async () => {
                const snap = await db.collection("users").get();
                const users = snap.docs.map(d => ({id: d.id, ...d.data()}));
                // Фильтр: Diff > currentTier * 1млрд
                const target = (session?.currentTier || 15) * 1000000000;
                const allowed = users
                    .map(u => {
                        const cur = u.final > 0 ? Number(u.final) : (u.intermediate > 0 ? Number(u.intermediate) : Number(u.base));
                        const diff = Math.max(0, cur - (Number(u.base) || 0));
                        return { id: u.id, name: u.name, diff };
                    })
                    .filter(u => u.diff >= target);
                
                await db.collection("lotterySessions").doc(SESSION_DOC_ID).update({ allowed, status: 'ready' });
            };

            if(!session) return <div className="p-10 text-center">Загрузка лотереи...</div>;

            return (
                <div className="h-full flex flex-col items-center justify-center p-4">
                    <div className="bg-slate-900/80 p-8 rounded-2xl border border-amber-500/30 text-center max-w-lg w-full">
                        <div className="text-amber-500 text-6xl font-black mb-4">
                            {session.status === 'rolling' ? <span className="animate-pulse">...</span> : (
                                session.lastWinner ? session.lastWinner.name.split('#')[0] : `${session.currentTier}G`
                            )}
                        </div>
                        <div className="text-slate-400 uppercase font-bold tracking-widest mb-6">
                            {session.status === 'rolling' ? 'ВРАЩЕНИЕ' : (
                                session.lastWinner ? 'ПОБЕДИТЕЛЬ' : 'ТЕКУЩИЙ ТИР'
                            )}
                        </div>
                        
                        {isAdmin && (
                            <div className="grid grid-cols-2 gap-2">
                                <button onClick={loadUsers} className="bg-blue-600 py-3 rounded font-bold text-white">Load Users</button>
                                <button onClick={startRoll} disabled={session.status === 'rolling'} className="bg-amber-600 py-3 rounded font-bold text-white">ROLL</button>
                                <button onClick={reset} className="col-span-2 bg-slate-700 py-2 rounded text-slate-400 text-xs">Reset Session</button>
                            </div>
                        )}
                        
                        <div className="mt-4 text-xs text-slate-500">
                            Участников: {session.allowed ? session.allowed.length : 0}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [tab, setTab] = useState('table');
            const [isAdmin, setIsAdmin] = useState(false);
            const [pass, setPass] = useState("");

            const checkPass = () => {
                if(pass === ACCESS_CODE) setIsAdmin(true);
                else alert("Неверно");
            };

            return (
                <div className="min-h-screen flex flex-col relative font-sans">
                    {/* Фон Снег */}
                    <div className="fixed inset-0 pointer-events-none">
                         {[...Array(20)].map((_,i) => <div key={i} className="snowflake" style={{left: Math.random()*100+'vw', animationDuration: 5+Math.random()*5+'s', opacity: 0.3}}>❄</div>)}
                    </div>

                    <nav className="bg-slate-900/80 border-b border-white/10 p-4 flex justify-between items-center z-10">
                        <div className="font-bold text-xl text-white flex items-center gap-2">
                            <Icon name="Gift" className="text-red-500" /> GUILD IONIA
                        </div>
                        <div className="flex gap-2 bg-slate-950 p-1 rounded-full">
                            <button onClick={() => setTab('table')} className={`px-4 py-1 rounded-full text-xs font-bold ${tab === 'table' ? 'bg-slate-700 text-white' : 'text-slate-500'}`}>Table</button>
                            <button onClick={() => setTab('lottery')} className={`px-4 py-1 rounded-full text-xs font-bold ${tab === 'lottery' ? 'bg-amber-600 text-white' : 'text-slate-500'}`}>Lottery</button>
                        </div>
                        <div className="flex gap-2">
                            {!isAdmin ? (
                                <div className="flex gap-1">
                                    <input type="password" value={pass} onChange={e => setPass(e.target.value)} className="bg-slate-950 border border-slate-700 w-20 text-xs px-2 rounded text-white" placeholder="Code" />
                                    <button onClick={checkPass} className="bg-slate-800 text-white px-2 rounded text-xs">Login</button>
                                </div>
                            ) : (
                                <button onClick={() => setIsAdmin(false)} className="text-red-400 text-xs border border-red-900 px-2 rounded">Exit</button>
                            )}
                        </div>
                    </nav>

                    <main className="flex-1 relative z-10 overflow-hidden">
                        {tab === 'table' && <GuildManager isAdmin={isAdmin} />}
                        {tab === 'lottery' && <LotterySystem isAdmin={isAdmin} />}
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>