
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GuildMaster Randomizer</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        guild: {
                            900: '#0f172a', // Slate 900
                            800: '#1e293b', // Slate 800
                            700: '#334155', // Slate 700
                            accent: '#f59e0b', // Amber 500 (Gold)
                        },
                        indigo: {
                            600: '#4f46e5',
                            500: '#6366f1',
                            400: '#818cf8',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- Polyfill for process (Fixes "process is not defined" crash) -->
    <script>
        window.process = {
            env: {
                NODE_ENV: 'production',
                API_KEY: '' 
            }
        };
    </script>

    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "recharts": "https://esm.sh/recharts@2.12.0?external=react,react-dom",
        "framer-motion": "https://esm.sh/framer-motion@10.16.4?external=react,react-dom",
        "canvas-confetti": "https://esm.sh/canvas-confetti@1.9.2",
        "@google/genai": "https://esm.sh/@google/genai@0.1.1",
        "firebase/app": "https://esm.sh/firebase@10.8.0/app",
        "firebase/firestore": "https://esm.sh/firebase@10.8.0/firestore"
      }
    }
    </script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #0f172a; color: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { Users, BarChart3, Dices, Sparkles, Shield, Trash2, Plus, Lock, LogOut, Upload, Save, Percent, Trophy, AlertCircle, RefreshCw } from 'lucide-react';
        import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell, ReferenceLine } from 'recharts';
        import { motion, useAnimation } from 'framer-motion';
        import confetti from 'canvas-confetti';
        import { GoogleGenAI } from "@google/genai";
        
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "firebase/app";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, writeBatch } from "firebase/firestore";

        // ==========================================
        // ‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò FIREBASE
        // ==========================================
        const firebaseConfig = {
          apiKey: "AIzaSyCIFKGZioiflKAAA1tHkIZV0u1sMiPzUjo",
          authDomain: "random-3fbaa.firebaseapp.com",
          projectId: "random-3fbaa",
          storageBucket: "random-3fbaa.firebasestorage.app",
          messagingSenderId: "891768940412",
          appId: "1:891768940412:web:312585e31aade1d7df66f9"
        };

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE ---
        let db = null;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase initialized successfully");
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", e);
        }

        // ==========================================
        // üíæ –î–ê–ù–ù–´–ï –î–õ–Ø –ó–ê–ì–†–£–ó–ö–ò (–ü–û –ó–ê–ü–†–û–°–£)
        // ==========================================
        const USER_PROVIDED_DATA = [
          { name: "–§–∞—Å–æ–ª—å #51817", current: 150, previous: 0 },
          { name: "May #97418", current: 723, previous: 0 },
          { name: "dimandorf #98147", current: 347, previous: 0 },
          { name: "Nezhdanchick #90542", current: 121, previous: 0 },
          { name: "–î–∞–º–µ–Ω—Ç–æ—Ä #5030", current: 375, previous: 0 },
          { name: "Adana #72323", current: 60, previous: 0 },
          { name: "Acya #62786", current: 241, previous: 0 },
          { name: "Shadow #24330", current: 97, previous: 0 },
          { name: "siff #07709", current: 243, previous: 0 },
          { name: "Mihajlovich #89594", current: 500, previous: 0 },
          { name: "Zarya #88690", current: 641, previous: 0 },
          { name: "INK #33036", current: 358, previous: 0 },
          { name: "Rainer #73242", current: 462, previous: 0 },
          { name: "Alena #20163", current: 284, previous: 0 },
          { name: "Alex #46688", current: 920, previous: 0 },
          { name: "Kalibr #3224", current: 88, previous: 0 },
          { name: "Aver1 #03710", current: 125, previous: 0 },
          { name: "Carana #38064", current: 307, previous: 0 }
        ];

        // ==========================================
        // üõ†Ô∏è –°–ï–†–í–ò–°–´ (AI)
        // ==========================================
        const analyzeGuildStats = async (members) => {
            const apiKey = window.process?.env?.API_KEY || "";
            if (!apiKey) {
                return "‚ö†Ô∏è –û–®–ò–ë–ö–ê: API Key –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–ª—é—á –¥–æ–±–∞–≤–ª–µ–Ω –≤ process.env.API_KEY.";
            }
            try {
                const ai = new GoogleGenAI({ apiKey: apiKey });
                
                const memberData = members.map(m => {
                    const diff = (m.endScore || 0) - (m.investments || 0);
                    return `${m.name}: –í–ª–æ–∂–µ–Ω–∏—è=${m.investments}, –†–∞–∑–Ω–∏—Ü–∞=${diff}`;
                }).join('\n');

                const prompt = `
                –¢—ã –∞–Ω–∞–ª–∏—Ç–∏–∫ –≥–∏–ª—å–¥–∏–∏. –î–∞–Ω–Ω—ã–µ:
                ${memberData}

                –î–∞–π –∫—Ä–∞—Ç–∫–∏–π –æ—Ç—á–µ—Ç (Markdown):
                1. –¢–æ–ø-3 MVP (—Ä–æ—Å—Ç).
                2. –ê—É—Ç—Å–∞–π–¥–µ—Ä—ã (—É–±—ã—Ç–æ–∫).
                3. –û–±—â–∏–π –≤–µ—Ä–¥–∏–∫—Ç.
                `;

                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: prompt,
                });
                return response.text;
            } catch (error) {
                console.error("Gemini Error:", error);
                return "–û—à–∏–±–∫–∞ AI —Å–µ—Ä–≤–∏—Å–∞: " + error.message;
            }
        };

        // ==========================================
        // üß© –ö–û–ú–ü–û–ù–ï–ù–¢–´
        // ==========================================

        // --- 1. –ì—Ä–∞—Ñ–∏–∫ ---
        const StatsChart = ({ members }) => {
            const data = useMemo(() => {
                return members.map(m => ({
                    ...m,
                    diff: (m.endScore || 0) - (m.investments || 0)
                })).sort((a, b) => b.diff - a.diff).slice(0, 15);
            }, [members]);

            return (
                <div className="w-full h-[400px] bg-guild-800 p-4 rounded-xl border border-guild-700 shadow-lg">
                    <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        üìä –¢–æ–ø –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–ü—Ä–∏–±—ã–ª—å)
                    </h3>
                    <ResponsiveContainer width="100%" height="100%">
                        <BarChart
                            data={data}
                            layout="vertical"
                            margin={{ top: 5, right: 30, left: 40, bottom: 5 }}
                        >
                            <CartesianGrid strokeDasharray="3 3" stroke="#334155" horizontal={false} />
                            <XAxis type="number" stroke="#94a3b8" tickFormatter={(val) => `${(val / 1000000).toFixed(0)}M`} />
                            <YAxis 
                                dataKey="name" 
                                type="category" 
                                width={120} 
                                stroke="#e2e8f0"
                                tick={{fontSize: 12}}
                            />
                            <Tooltip 
                                contentStyle={{ backgroundColor: '#1e293b', borderColor: '#475569', color: '#fff' }}
                                cursor={{fill: '#334155', opacity: 0.4}}
                                formatter={(value) => [`${value.toLocaleString()} G`, '–†–∞–∑–Ω–∏—Ü–∞']}
                            />
                            <ReferenceLine x={0} stroke="#64748b" />
                            <Bar dataKey="diff" radius={[0, 4, 4, 0]} barSize={20}>
                                {data.map((entry, index) => (
                                    <Cell 
                                        key={`cell-${index}`} 
                                        fill={entry.diff < 0 ? '#ef4444' : index === 0 ? '#f59e0b' : index === 1 ? '#cbd5e1' : index === 2 ? '#b45309' : '#8b5cf6'} 
                                    />
                                ))}
                            </Bar>
                        </BarChart>
                    </ResponsiveContainer>
                </div>
            );
        };

        // --- 2. –¢–∞–±–ª–∏—Ü–∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è ---
        const GuildManager = ({ members, setMembers, dates, setDates, isAdmin }) => {
            const formatNumber = (num) => num ? num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ") : "0";
            const parseNumber = (value) => {
                const cleaned = value.replace(/\s/g, '');
                return cleaned === '' ? 0 : parseInt(cleaned, 10);
            };

            const handleUpdate = async (id, field, value) => {
                const updatedMembers = members.map(m => m.id === id ? { ...m, [field]: value } : m);
                setMembers(updatedMembers);

                if (db) {
                    try {
                        const docRef = doc(db, "members", id);
                        await setDoc(docRef, { [field]: value }, { merge: true });
                    } catch (e) { console.error("Error saving:", e); }
                }
            };

            const handleRemove = async (id) => {
                if (!isAdmin) return;
                if (!confirm("–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞?")) return;
                setMembers(members.filter(m => m.id !== id));
                if (db) {
                    await deleteDoc(doc(db, "members", id));
                }
            };

            const handleAdd = async () => {
                const newMember = {
                    id: Date.now().toString(),
                    name: '–ù–æ–≤—ã–π –ò–≥—Ä–æ–∫',
                    investments: 0,
                    startScore: 0,
                    endScore: 0,
                    reward: ''
                };
                setMembers([...members, newMember]);
                if (db) {
                    await setDoc(doc(db, "members", newMember.id), newMember);
                }
            };

            return (
                <div className="bg-white rounded-lg shadow-lg overflow-hidden text-black">
                    <div className="overflow-x-auto">
                        <table className="w-full border-collapse text-sm">
                            <thead>
                                <tr className="bg-gray-100 border-b-2 border-gray-300 text-black">
                                    <th className="px-4 py-2 text-left font-bold border-r border-gray-300 w-1/6">–ù–∏–∫</th>
                                    <th className="px-4 py-2 text-left font-bold border-r border-gray-300 w-1/6">–í–ª–æ–∂–µ–Ω–∏—è</th>
                                    <th className="px-4 py-2 text-left font-bold border-r border-gray-300 w-1/6">–°—Ç–∞—Ä—Ç</th>
                                    <th className="px-4 py-2 text-left font-bold border-r border-gray-300 w-1/6">–ò—Ç–æ–≥</th>
                                    <th className="px-4 py-2 text-left font-bold border-r border-gray-300 w-1/6 bg-blue-50 text-blue-900">–†–∞–∑–Ω–∏—Ü–∞</th>
                                    <th className="px-4 py-2 text-left font-bold border-gray-300 w-1/6">–ù–∞–≥—Ä–∞–¥–∞ (G)</th>
                                    {isAdmin && <th className="w-10"></th>}
                                </tr>
                            </thead>
                            <tbody>
                                {members.length === 0 ? (
                                    <tr><td colSpan={7} className="text-center py-8 text-gray-500">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ –∞–¥–º–∏–Ω–∫–µ.</td></tr>
                                ) : members.map((member, index) => {
                                    const difference = (member.endScore || 0) - (member.investments || 0);
                                    const diffClass = difference > 0 ? 'text-green-700 font-bold' : difference < 0 ? 'text-red-700' : 'text-black';
                                    
                                    return (
                                        <tr key={member.id} className={`border-b border-gray-200 hover:bg-blue-50 transition-colors ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                                            <td className="border-r border-gray-200 p-1">
                                                <input 
                                                    type="text" 
                                                    value={member.name}
                                                    disabled={!isAdmin}
                                                    onChange={(e) => handleUpdate(member.id, 'name', e.target.value)}
                                                    className="w-full px-2 py-1 outline-none bg-transparent font-medium text-black placeholder-gray-400 disabled:opacity-100"
                                                />
                                            </td>
                                            <td className="border-r border-gray-200 p-1">
                                                <input 
                                                    type="text" 
                                                    value={formatNumber(member.investments)}
                                                    disabled={!isAdmin}
                                                    onChange={(e) => {
                                                        const val = parseNumber(e.target.value);
                                                        if (!isNaN(val)) handleUpdate(member.id, 'investments', val);
                                                    }}
                                                    className="w-full px-2 py-1 outline-none bg-transparent font-mono text-right text-black placeholder-gray-400 disabled:opacity-100"
                                                />
                                            </td>
                                            <td className="border-r border-gray-200 p-1">
                                                <input 
                                                    type="number" 
                                                    value={member.startScore || ''}
                                                    disabled={!isAdmin}
                                                    onChange={(e) => handleUpdate(member.id, 'startScore', parseInt(e.target.value) || 0)}
                                                    className="w-full px-2 py-1 outline-none bg-transparent text-center text-black placeholder-gray-400 disabled:opacity-100"
                                                />
                                            </td>
                                            <td className="border-r border-gray-200 p-1">
                                                <input 
                                                    type="number" 
                                                    value={member.endScore || ''}
                                                    disabled={!isAdmin}
                                                    onChange={(e) => handleUpdate(member.id, 'endScore', parseInt(e.target.value) || 0)}
                                                    className="w-full px-2 py-1 outline-none bg-transparent text-center text-black placeholder-gray-400 disabled:opacity-100"
                                                />
                                            </td>
                                            <td className={`border-r border-gray-200 p-2 text-center bg-blue-50/50 ${diffClass}`}>
                                                {formatNumber(difference)}
                                            </td>
                                            <td className="border-r border-gray-200 p-1">
                                                 <input 
                                                    type="text" 
                                                    value={member.reward}
                                                    disabled={!isAdmin}
                                                    onChange={(e) => handleUpdate(member.id, 'reward', e.target.value)}
                                                    className="w-full px-2 py-1 outline-none bg-transparent text-black placeholder-gray-400 disabled:opacity-100"
                                                />
                                            </td>
                                            {isAdmin && (
                                                <td className="p-1 text-center">
                                                    <button onClick={() => handleRemove(member.id)} className="text-red-500 hover:text-red-700 p-1 rounded">
                                                        <Trash2 className="w-4 h-4" />
                                                    </button>
                                                </td>
                                            )}
                                        </tr>
                                    );
                                })}
                                {isAdmin && (
                                    <tr className="bg-gray-50">
                                        <td colSpan={7} className="p-2 text-center border-t border-gray-300">
                                            <button onClick={handleAdd} className="flex items-center justify-center gap-2 w-full text-gray-600 hover:text-black py-2 font-medium">
                                                <Plus className="w-4 h-4" /> –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É
                                            </button>
                                        </td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- 3. –°–∏—Å—Ç–µ–º–∞ –†–æ–∑—ã–≥—Ä—ã—à–∞ (–†—É–ª–µ—Ç–∫–∞) ---
        const Roulette = ({ participants, winner, isSpinning, onSpinComplete }) => {
            const controls = useAnimation();
            const containerRef = useRef(null);
            const [tape, setTape] = useState([]);
            const [isFinished, setIsFinished] = useState(false);

            const CARD_WIDTH = 180;
            const GAP = 12;
            const WINNER_INDEX = 50; 

            useEffect(() => {
                if (isSpinning) setIsFinished(false);
                if (isSpinning && winner && participants.length > 0) {
                    const buffer = Array.from({ length: WINNER_INDEX }).map(() => 
                        participants[Math.floor(Math.random() * participants.length)]
                    );
                    const endBuffer = Array.from({ length: 10 }).map(() =>
                         participants[Math.floor(Math.random() * participants.length)]
                    );
                    setTape([...buffer, winner, ...endBuffer]);
                    spinToWinner();
                }
            }, [isSpinning, winner]);

            const spinToWinner = async () => {
                if (!containerRef.current) return;
                await controls.set({ x: 0 });
                const containerWidth = containerRef.current.offsetWidth;
                const cardFullWidth = CARD_WIDTH + GAP;
                const targetX = -1 * (WINNER_INDEX * cardFullWidth) + (containerWidth / 2) - (CARD_WIDTH / 2);
                const randomOffset = (Math.random() * (CARD_WIDTH * 0.6)) - (CARD_WIDTH * 0.3);

                await controls.start({
                    x: targetX + randomOffset,
                    transition: { duration: 6, ease: [0.15, 0.85, 0.35, 1] },
                });
                setIsFinished(true);
                onSpinComplete();
            };

            if (!isSpinning && !winner && !isFinished) {
                return <div className="w-full h-52 bg-gray-900 rounded-xl border border-gray-700 flex items-center justify-center text-gray-500">–û–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞—Ä—Ç–∞...</div>;
            }

            return (
                <div className="relative w-full max-w-5xl mx-auto mb-8 h-52 bg-gray-900 rounded-xl border border-gray-700 overflow-hidden shadow-2xl" ref={containerRef}>
                    <div className="absolute top-0 bottom-0 left-1/2 w-1 bg-yellow-500 z-30 transform -translate-x-1/2 shadow-[0_0_15px_rgba(234,179,8,0.8)]"></div>
                    <div className="absolute top-0 left-1/2 transform -translate-x-1/2 text-yellow-500 z-30 text-2xl drop-shadow-md">‚ñº</div>
                    <motion.div className="flex items-center h-full px-4" initial={{ x: 0 }} animate={controls}>
                        {tape.map((p, i) => {
                            const isWinnerCard = isFinished && i === WINNER_INDEX;
                            return (
                                <div key={i} className={`flex-shrink-0 relative rounded-lg flex flex-col items-center justify-center border-2 transition-all duration-500 ${isWinnerCard ? 'border-yellow-500 bg-yellow-900/30 shadow-[0_0_30px_rgba(234,179,8,0.4)] scale-105 z-10' : 'border-gray-700 bg-gray-800'}`} style={{ width: CARD_WIDTH, height: 160, marginRight: GAP }}>
                                    <div className="w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center mb-2 text-lg font-bold text-gray-300">{p.name[0]}</div>
                                    <div className={`font-bold px-2 text-center truncate w-full ${isWinnerCard ? 'text-yellow-400' : 'text-white'}`}>{p.name}</div>
                                    <div className="text-xs text-gray-500 mt-1 bg-gray-900/50 px-2 py-1 rounded">{p.score} G</div>
                                </div>
                            );
                        })}
                    </motion.div>
                </div>
            );
        };

        const STAGES = [
            { threshold: 15, prize: "120 üíé", count: 3, title: "–ù–û–í–ò–ß–û–ö" },
            { threshold: 25, prize: "180 üíé", count: 2, title: "–õ–Æ–ë–ò–¢–ï–õ–¨" },
            { threshold: 50, prize: "400 üíé", count: 1, title: "–û–ü–´–¢–ù–´–ô" },
            { threshold: 75, prize: "600 üíé", count: 1, title: "–ì–†–ê–ù–î-–ú–ê–°–¢–ï–†" },
            { threshold: 100, prize: "900 üíé", count: 1, title: "–≠–õ–ò–¢–ê" },
            { threshold: 125, prize: "2000 üíé", count: 1, title: "–õ–ï–ì–ï–ù–î–ê" },
        ];

        const LotterySystem = ({ members }) => {
            const [stageIdx, setStageIdx] = useState(0);
            const [history, setHistory] = useState([]);
            const [winner, setWinner] = useState(null);
            const [isSpinning, setIsSpinning] = useState(false);
            const [winnersFound, setWinnersFound] = useState(0);
            
            const stage = STAGES[stageIdx] || STAGES[STAGES.length - 1];
            const isFinished = stageIdx >= STAGES.length;

            const allParticipants = useMemo(() => members.map(m => {
                const diff = (m.endScore || 0) - (m.investments || 0);
                const score = Math.floor(diff / 1000000); // 1M = 1G
                return {
                    id: m.id,
                    name: m.name,
                    score: score > 0 ? score : 0
                };
            }).filter(p => p.score > 0), [members]);

            const eligible = useMemo(() => {
                if (isFinished) return [];
                return allParticipants.filter(p => {
                    return p.score >= stage.threshold && !history.some(h => h.name === p.name && h.stage === `${stage.threshold}G`);
                });
            }, [allParticipants, stage, isFinished, history]);

            const handleSpin = () => {
                if (!eligible.length) return alert("–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏!");
                const randomWin = eligible[Math.floor(Math.random() * eligible.length)];
                setWinner(randomWin);
                setIsSpinning(true);
            };

            const handleComplete = () => {
                setIsSpinning(false);
                if (!winner) return;
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#fbbf24', '#8b5cf6', '#ffffff'] });
                setHistory(prev => [...prev, { stage: `${stage.threshold}G`, name: winner.name, prize: stage.prize }]);
                if (winnersFound + 1 < stage.count) {
                    setWinnersFound(p => p + 1);
                } else {
                    setTimeout(() => {
                        setWinnersFound(0);
                        setStageIdx(p => p + 1);
                    }, 2000);
                }
            };

            if (isFinished) return (
                <div className="bg-guild-800 p-8 rounded-xl border-2 border-green-500 max-w-4xl mx-auto shadow-2xl text-center animate-fade-in">
                    <Trophy className="w-24 h-24 text-yellow-500 mx-auto mb-4 animate-bounce" />
                    <h2 className="text-3xl text-green-400 mb-6 font-bold">üèÜ –†–û–ó–´–ì–†–´–® –ó–ê–í–ï–†–®–ï–ù</h2>
                    <div className="grid grid-cols-1 gap-2 text-left">{history.map((h, i) => (
                        <div key={i} className="bg-guild-900 p-4 rounded-lg flex justify-between items-center border border-guild-700">
                             <div className="flex items-center gap-3"><span className="text-guild-accent font-mono font-bold w-16">{h.stage}</span><span className="text-white font-bold text-lg">{h.name}</span></div>
                             <span className="text-yellow-400 font-bold">{h.prize}</span>
                        </div>
                    ))}</div>
                </div>
            );

            return (
                <div className="w-full max-w-6xl mx-auto space-y-6">
                    {/* –ò–Ω—Ñ–æ */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-gradient-to-br from-blue-900 to-guild-900 p-5 rounded-xl border border-blue-700 shadow-lg relative overflow-hidden">
                            <div className="relative z-10">
                                <div className="text-blue-300 text-xs font-bold uppercase tracking-widest mb-1 flex items-center gap-2"><Sparkles className="w-3 h-3" /> {stage.title}</div>
                                <div className="text-5xl font-black text-white">{stage.threshold}<span className="text-3xl text-blue-400">G</span></div>
                                <div className="mt-2 text-blue-200 bg-black/20 inline-block px-3 py-1 rounded-lg border border-blue-500/30">–ü—Ä–∏–∑: <span className="text-yellow-400 font-bold">{stage.prize}</span></div>
                            </div>
                        </div>
                        <div className="bg-guild-800 p-5 rounded-xl border border-guild-700 flex flex-col justify-center relative">
                            <div className="text-gray-400 text-xs uppercase mb-2 flex items-center gap-2"><Trophy className="w-3 h-3" /> –ü—Ä–æ–≥—Ä–µ—Å—Å —ç—Ç–∞–ø–∞</div>
                            <div className="flex items-end gap-2 z-10"><span className="text-4xl font-bold text-yellow-500">{winnersFound}</span><span className="text-xl text-gray-500 mb-1">/ {stage.count}</span></div>
                            <div className="w-full bg-guild-900 h-2 rounded-full mt-3 overflow-hidden border border-guild-700"><div className="bg-yellow-500 h-full transition-all duration-500" style={{ width: `${(winnersFound / stage.count) * 100}%` }}></div></div>
                        </div>
                        <div className="bg-guild-800 p-5 rounded-xl border border-guild-700 flex flex-col justify-center relative">
                           <div className="flex justify-between items-center mb-1"><span className="text-green-400 text-xs font-bold uppercase tracking-wider">–î–æ–ø—É—â–µ–Ω—ã</span><span className="text-3xl text-white font-bold">{eligible.length}</span></div>
                           <div className="w-full bg-guild-700 h-px my-2"></div>
                           <div className="flex justify-between items-center"><span className="text-red-400 text-xs">–ù–µ –ø—Ä–æ—à–ª–∏ / –í—ã–∏–≥—Ä–∞–ª–∏</span><span className="text-lg text-gray-500 font-mono">{allParticipants.length - eligible.length}</span></div>
                        </div>
                    </div>

                    <Roulette participants={eligible} winner={winner} isSpinning={isSpinning} onSpinComplete={handleComplete} />

                    <div className="flex justify-center">
                        <button onClick={handleSpin} disabled={isSpinning || eligible.length === 0} className={`relative overflow-hidden px-16 py-5 rounded-2xl text-2xl font-bold uppercase tracking-widest shadow-2xl transition-all transform ${isSpinning || eligible.length === 0 ? 'bg-guild-800 text-gray-600 cursor-not-allowed border border-guild-700' : 'bg-gradient-to-r from-guild-accent to-indigo-600 text-white hover:scale-105 hover:shadow-indigo-500/30 ring-1 ring-indigo-400/50'}`}>
                            <span className="relative z-10 flex items-center gap-3">{isSpinning ? '–í—Ä–∞—â–∞–µ–º...' : '–†–∞–∑—ã–≥—Ä–∞—Ç—å –ø—Ä–∏–∑'} {!isSpinning && <Sparkles className="w-5 h-5 text-yellow-300" />}</span>
                        </button>
                    </div>

                    {/* –¢–∞–±–ª–∏—Ü–∞ –®–∞–Ω—Å–æ–≤ */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-2 bg-guild-800 rounded-xl border border-guild-700 overflow-hidden shadow-lg">
                            <div className="p-4 border-b border-guild-700 bg-guild-900/50 flex justify-between items-center">
                                <h3 className="font-bold text-white flex items-center gap-2"><Percent className="w-5 h-5 text-guild-accent" /> –®–∞–Ω—Å—ã (–¢–æ–ø 50)</h3>
                            </div>
                            <div className="max-h-[300px] overflow-y-auto custom-scrollbar">
                                <table className="w-full text-left text-sm">
                                    <thead className="bg-guild-900 text-gray-400 sticky top-0"><tr><th className="p-3">–£—á–∞—Å—Ç–Ω–∏–∫</th><th className="p-3 text-center">–ü—Ä–æ—Ñ–∏—Ç (G)</th><th className="p-3">–®–∞–Ω—Å</th></tr></thead>
                                    <tbody className="divide-y divide-guild-700/50">{eligible.slice(0, 50).map(p => (
                                        <tr key={p.id} className="hover:bg-guild-700/30"><td className="p-3 text-white">{p.name}</td><td className="p-3 text-center font-mono text-gray-300">{p.score}</td><td className="p-3"><span className="text-guild-accent font-bold">{(100/eligible.length).toFixed(1)}%</span></td></tr>
                                    ))}</tbody>
                                </table>
                            </div>
                        </div>
                        <div className="bg-guild-800 rounded-xl border border-guild-700 overflow-hidden shadow-lg">
                            <div className="p-4 border-b border-guild-700 bg-guild-900/50"><h3 className="font-bold text-white flex items-center gap-2"><Users className="w-5 h-5 text-gray-400" /> –ò—Å—Ç–æ—Ä–∏—è –ü–æ–±–µ–¥</h3></div>
                            <div className="p-4 max-h-[300px] overflow-y-auto custom-scrollbar space-y-2">
                                {history.length === 0 && <div className="text-gray-500 text-center italic">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>}
                                {history.map((h, i) => (
                                    <div key={i} className="flex justify-between items-center bg-guild-900/50 p-3 rounded border border-guild-700/50">
                                        <div><div className="text-white font-bold text-sm">{h.name}</div><div className="text-[10px] text-gray-500 uppercase">{h.stage}</div></div>
                                        <div className="text-right"><div className="text-yellow-400 font-bold text-sm">{h.prize}</div></div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // üöÄ –ì–õ–ê–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï
        // ==========================================
        const App = () => {
            const [activeTab, setActiveTab] = useState('members');
            const [members, setMembers] = useState([]);
            const [dates, setDates] = useState({ start: '15.11.2025', end: '01.01.2026' });
            const [isAdmin, setIsAdmin] = useState(false);
            const [passwordInput, setPasswordInput] = useState("");
            const [showLogin, setShowLogin] = useState(false);
            const [aiAnalysis, setAiAnalysis] = useState('');
            const [isAnalyzing, setIsAnalyzing] = useState(false);

            useEffect(() => {
                if (db) {
                    try {
                        const unsubscribe = onSnapshot(collection(db, "members"), (snapshot) => {
                            const loadedMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            loadedMembers.sort((a,b) => parseInt(a.id || 0) - parseInt(b.id || 0));
                            setMembers(loadedMembers);
                        }, (error) => {
                            console.error("Snapshot error:", error);
                        });
                        return () => unsubscribe();
                    } catch (err) {
                        console.error("Firebase connection error:", err);
                    }
                }
            }, []);

            const handleLogin = (e) => {
                e.preventDefault();
                if (passwordInput === "GM123") {
                    setIsAdmin(true);
                    setShowLogin(false);
                    setPasswordInput("");
                } else {
                    alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
                }
            };

            // 3. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î (–ö–Ω–æ–ø–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è)
            const uploadUserData = async () => {
                if (!db) {
                    alert("–û—à–∏–±–∫–∞: Firebase –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω.");
                    return;
                }
                if (!confirm(`–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≥–∏–ª—å–¥–∏–∏ (${USER_PROVIDED_DATA.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)? –≠—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ.`)) return;
                
                try {
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ —á–∏—â–µ –¥–ª—è –¥–µ–º–æ)
                    const batch = writeBatch(db);
                    
                    // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º/–ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –ø–æ ID
                    USER_PROVIDED_DATA.forEach((user, index) => {
                        const id = (1000 + index).toString(); // –ü—Ä–æ—Å—Ç–æ–π ID
                        const ref = doc(db, "members", id);
                        
                        // –ú–∞–ø–ø–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                        // user.current (150) -> investments (150 000 000)
                        // user.previous (0) -> startScore (0)
                        // endScore = investments (—á—Ç–æ–±—ã —Ä–∞–∑–Ω–∏—Ü–∞ –±—ã–ª–∞ 0 –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ, –∏–ª–∏ –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–Ω–∞—á–µ)
                        const valInMillions = user.current * 1000000;
                        
                        batch.set(ref, {
                            id: id,
                            name: user.name,
                            investments: valInMillions, 
                            startScore: user.previous * 1000000,
                            endScore: valInMillions, 
                            reward: ''
                        });
                    });
                    
                    await batch.commit();
                    alert(`–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${USER_PROVIDED_DATA.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤!`);
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", error);
                    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: " + error.message);
                }
            };

            const handleAnalyze = async () => {
                setIsAnalyzing(true);
                const res = await analyzeGuildStats(members);
                setAiAnalysis(res);
                setIsAnalyzing(false);
            };

            return (
                <div className="min-h-screen bg-guild-900 text-gray-100 font-sans pb-12">
                    {/* Header */}
                    <header className="bg-guild-800 border-b border-guild-700 sticky top-0 z-50 shadow-md">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <div className="bg-guild-accent p-2 rounded-lg"><Shield className="w-6 h-6 text-white" /></div>
                                <h1 className="text-xl font-bold tracking-wide text-white">Guild<span className="text-guild-accent">Master</span></h1>
                            </div>
                            
                            <div className="flex items-center gap-4">
                                <nav className="flex gap-1 md:gap-4">
                                    <button onClick={() => setActiveTab('members')} className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-all ${activeTab === 'members' ? 'bg-guild-700 text-white' : 'text-gray-400 hover:text-white'}`}><Users className="w-4 h-4" /><span className="hidden md:inline">–¢–∞–±–ª–∏—Ü–∞</span></button>
                                    <button onClick={() => setActiveTab('stats')} className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-all ${activeTab === 'stats' ? 'bg-guild-700 text-white' : 'text-gray-400 hover:text-white'}`}><BarChart3 className="w-4 h-4" /><span className="hidden md:inline">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span></button>
                                    <button onClick={() => setActiveTab('lottery')} className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-all ${activeTab === 'lottery' ? 'bg-guild-700 text-white' : 'text-gray-400 hover:text-white'}`}><Dices className="w-4 h-4" /><span className="hidden md:inline">–†–æ–∑—ã–≥—Ä—ã—à</span></button>
                                </nav>
                                <div className="border-l border-guild-700 pl-4">
                                    {isAdmin ? (
                                        <button onClick={() => setIsAdmin(false)} className="flex items-center gap-2 text-red-400 hover:text-red-300" title="–í—ã–π—Ç–∏ –∏–∑ –∞–¥–º–∏–Ω–∫–∏">
                                            <LogOut className="w-5 h-5" />
                                        </button>
                                    ) : (
                                        <button onClick={() => setShowLogin(true)} className="flex items-center gap-2 text-gray-400 hover:text-white" title="–í–æ–π—Ç–∏ –∫–∞–∫ GM">
                                            <Lock className="w-5 h-5" />
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* –ú–æ–¥–∞–ª–∫–∞ –ª–æ–≥–∏–Ω–∞ */}
                    {showLogin && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100]">
                            <form onSubmit={handleLogin} className="bg-guild-800 p-6 rounded-xl border border-guild-700 shadow-2xl w-80">
                                <h3 className="text-xl font-bold text-white mb-4">–î–æ—Å—Ç—É–ø GM</h3>
                                <input 
                                    type="password" 
                                    value={passwordInput} 
                                    onChange={e => setPasswordInput(e.target.value)} 
                                    className="w-full bg-guild-900 border border-guild-700 rounded p-2 text-white mb-4 outline-none focus:border-guild-accent"
                                    placeholder="–ü–∞—Ä–æ–ª—å"
                                    autoFocus
                                />
                                <div className="flex gap-2 justify-end">
                                    <button type="button" onClick={() => setShowLogin(false)} className="px-3 py-1 text-gray-400 hover:text-white">–û—Ç–º–µ–Ω–∞</button>
                                    <button type="submit" className="bg-guild-accent text-white px-4 py-1 rounded hover:bg-yellow-600">–í–æ–π—Ç–∏</button>
                                </div>
                            </form>
                        </div>
                    )}

                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 animate-fade-in">
                        
                        {/* –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω) */}
                        {isAdmin && (
                            <div className="mb-8 p-4 bg-red-900/20 border border-red-500/30 rounded-lg flex flex-col md:flex-row justify-between items-center gap-4">
                                <div className="flex items-center gap-3">
                                    <Shield className="w-6 h-6 text-red-400" />
                                    <div>
                                        <h3 className="font-bold text-red-100">–†–µ–∂–∏–º –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
                                        <p className="text-xs text-red-300">–í—ã –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–º–∏.</p>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                     <button 
                                        onClick={uploadUserData}
                                        className="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-bold shadow-lg transition-transform hover:scale-105"
                                    >
                                        <RefreshCw className="w-4 h-4" /> –ó–∞–≥—Ä—É–∑–∏—Ç—å –°–ø–∏—Å–æ–∫ –ì–∏–ª—å–¥–∏–∏
                                    </button>
                                </div>
                            </div>
                        )}

                        {activeTab === 'members' && (
                            <GuildManager members={members} setMembers={setMembers} dates={dates} setDates={setDates} isAdmin={isAdmin} />
                        )}

                        {activeTab === 'stats' && (
                            <div className="space-y-8">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold text-white">–ê–Ω–∞–ª–∏–∑ –ü—Ä–æ–≥—Ä–µ—Å—Å–∞</h2>
                                    <button onClick={handleAnalyze} disabled={isAnalyzing} className="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 disabled:opacity-50">
                                        <Sparkles className="w-4 h-4" /> {isAnalyzing ? '–î—É–º–∞—é...' : '–°–ø—Ä–æ—Å–∏—Ç—å –û—Ä–∞–∫—É–ª–∞ (AI)'}
                                    </button>
                                </div>
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <StatsChart members={members} />
                                    <div className="bg-guild-800 p-6 rounded-xl border border-guild-700 shadow-lg min-h-[400px]">
                                        <h3 className="text-xl font-bold text-white mb-4 border-b border-guild-700 pb-2">–û—Ç—á–µ—Ç –û—Ä–∞–∫—É–ª–∞</h3>
                                        {aiAnalysis ? (
                                            <div className="prose prose-invert prose-sm max-w-none" dangerouslySetInnerHTML={{ __html: aiAnalysis.replace(/\n/g, '<br/>').replace(/\*\*(.*?)\*\*/g, '<strong class="text-guild-accent">$1</strong>') }} />
                                        ) : (
                                            <div className="flex flex-col items-center justify-center h-[300px] text-gray-500"><Sparkles className="w-12 h-12 mb-4 opacity-20" /><p className="text-center">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.</p></div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'lottery' && (
                            <LotterySystem members={members} />
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>